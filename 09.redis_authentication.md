# Secci√≥n 09: Redis Authentication

---

## Introducci√≥n a Access Control List (ACL)

`Redis`, por defecto, no requiere autenticaci√≥n en una instalaci√≥n b√°sica. Esto significa que cualquier cliente que se
conecte puede ejecutar comandos sin restricci√≥n, lo cual no es recomendable en entornos productivos.

Algunos puntos clave:

- El usuario `default` tiene privilegios de administrador y no requiere contrase√±a al inicio.
- En `Redis < 6`:
    - No exist√≠a el concepto de usuarios.
    - Solo se pod√≠a configurar una contrase√±a global.
    - Se utilizaba: `AUTH <password>`
- En `Redis >= 6`:
    - Se introdujo el sistema ACL (Access Control List).
    - Permite definir usuarios con nombre, contrase√±a y privilegios espec√≠ficos.
    - Se autentica con: `AUTH <username> <password>`

### Comandos principales de ACL

| Comando                              | Descripci√≥n                                           |
|--------------------------------------|-------------------------------------------------------|
| `ACL LIST`                           | Lista todos los usuarios configurados y sus permisos. |
| `ACL WHOAMI`                         | Muestra el usuario actualmente autenticado.           |
| `ACL SETUSER [username] >[password]` | Crea o actualiza un usuario con contrase√±a.           |
| `ACL SETUSER [username] nopass`      | Crea un usuario sin contrase√±a.                       |
| `ACL SETUSER [username] on`          | Habilita al usuario.                                  |
| `ACL SETUSER [username] off`         | Deshabilita al usuario.                               |
| `ACL DELUSER [username]`             | Elimina un usuario.                                   |

### Ejemplos pr√°cticos

- Ver usuarios actuales

````bash
127.0.0.1:6379> acl list
1) "user default on nopass sanitize-payload ~* &* +@all"
````

El resultado indica:

- `default`: usuario activo.
- `nopass`: sin contrase√±a.
- `+@all`: permisos completos.

- Ver usuario actual

````bash
127.0.0.1:6379> acl whoami
"default" 
````

- Crear usuarios

````bash
127.0.0.1:6379> ACL SETUSER sam on >'secret'
OK
127.0.0.1:6379> ACL SETUSER jake >'secret'
OK
127.0.0.1:6379> ACL SETUSER magadiflo >123456
OK 
````

üìå Observaciones:

- `>` indica que lo que sigue es la contrase√±a.
- Por defecto, el usuario reci√©n creado queda deshabilitado a menos que uses on.

- Revisar usuarios

````bash
127.0.0.1:6379> acl list
1) "user default on nopass sanitize-payload ~* &* +@all"
2) "user jake off sanitize-payload #2bb80d537b1da3e38bd30361aa855686bde0eacd7162fef6a25fe97bf527a25b resetchannels -@all"
3) "user magadiflo off sanitize-payload #8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92 resetchannels -@all"
4) "user sam on sanitize-payload #2bb80d537b1da3e38bd30361aa855686bde0eacd7162fef6a25fe97bf527a25b resetchannels -@all" 
````

Notas:

- El `#<hash>` corresponde al hash `SHA-256` de la contrase√±a.
- `resetchannels` y `-@all` aparecen porque los usuarios no tienen permisos definidos expl√≠citamente.

- Eliminar usuarios

````bash
127.0.0.1:6379> acl deluser jake sam
(integer) 2 
````

- Habilitar un usuario existente

````bash
127.0.0.1:6379> acl setuser magadiflo on
OK 
````

- Autenticarse con un usuario distinto

````bash
127.0.0.1:6379> auth magadiflo 123456
OK 
````

- Regresamos al usuario default

````bash
127.0.0.1:6379> auth default nopass
OK 
````

- Confirmar usuario actual

````bash
127.0.0.1:6379> acl whoami
"default" 
````

### Notas importantes

- En producci√≥n, nunca uses el usuario `default` con acceso total y sin contrase√±a.
- Es recomendable:
    - Deshabilitar `default` `(ACL SETUSER default off)`.
    - Crear usuarios espec√≠ficos con permisos limitados seg√∫n el caso de uso.
- Los permisos se definen con `categor√≠as` (`+@read`, `+@write`, `+@admin`, etc.) o comandos individuales
  (`+get`, `-del`, etc.).
- Los usuarios pueden restringirse tambi√©n a claves espec√≠ficas `(~prefix:*)`.

## Access Control List - Configurando permisos

La forma general de crear un usuario en Redis con ACL es:

````bash
ACL SETUSER [username] >[password] ON 
````

Al crear un usuario podemos asignarle permisos de acceso a comandos y claves.

### Principales flags de permisos

- Permisos sobre comandos
    - `allcommands` o `+@all`: acceso a todos los comandos.
    - `+@set`, `+@hash`, `+@list`: acceso a categor√≠as espec√≠ficas de comandos (sets, hashes, listas, etc.).
    - `+[command]`: habilita un comando individual.
    - `-[command]`: deshabilita un comando individual.
    - Ejemplo:
        - `-get` ‚Üí niega el comando GET.
        - `+set` ‚Üí permite el comando SET.
- Permisos sobre claves
    - `allkeys` o `~*`: acceso a todas las claves.
    - `~prefix:*`: acceso restringido a claves que empiecen con `prefix:`.
    - Ejemplo:
        - `~numbers:*` ‚Üí acceso a todas las claves con prefijo `numbers:`.

### Ejemplos pr√°cticos

- Crear un usuario con acceso total

````bash
127.0.0.1:6379> acl setuser magadiflo >pass123 on allcommands allkeys
OK
````

- Ver configuraci√≥n de usuarios

````bash
127.0.0.1:6379> acl list
1) "user default on nopass sanitize-payload ~* &* +@all"
2) "user magadiflo on sanitize-payload #9b8769a4a742959a2d0298c36fb70623f2dfacda8436237df08d8dfd5b37374c ~* resetchannels +@all"
````

üìå El hash (#9b87...) corresponde a la contrase√±a almacenada en formato SHA-256.

- Autenticarse como nuevo usuario

````bash
127.0.0.1:6379> auth magadiflo pass123
OK 

127.0.0.1:6379> acl whoami
"magadiflo" 
````

- Usar comandos con permisos completos

````bash
127.0.0.1:6379> set product laptop
OK
127.0.0.1:6379> get product
"laptop" 
````

- Volver al usuario `default`

````bash
127.0.0.1:6379> auth default nopass   
OK                                     
````

- Quitamos permiso al comando GET para el usuario `magadiflo`

````bash
127.0.0.1:6379> acl setuser magadiflo -get
OK 
````

- Verificamos cambios

````bash
127.0.0.1:6379> acl list
1) "user default on nopass sanitize-payload ~* &* +@all"
2) "user magadiflo on sanitize-payload #9b8769a4a742959a2d0298c36fb70623f2dfacda8436237df08d8dfd5b37374c ~* resetchannels +@all -get" 
````

- Intentar usar un comando restringido

````bash
127.0.0.1:6379> auth magadiflo pass123
OK 

127.0.0.1:6379> get product
(error) NOPERM User magadiflo has no permissions to run the 'get' command
````
