# Secci√≥n 09: Redis Authentication

---

## Introducci√≥n a Access Control List (ACL)

`Redis`, por defecto, no requiere autenticaci√≥n en una instalaci√≥n b√°sica. Esto significa que cualquier cliente que se
conecte puede ejecutar comandos sin restricci√≥n, lo cual no es recomendable en entornos productivos.

Algunos puntos clave:

- El usuario `default` tiene privilegios de administrador y no requiere contrase√±a al inicio.
- En `Redis < 6`:
    - No exist√≠a el concepto de usuarios.
    - Solo se pod√≠a configurar una contrase√±a global.
    - Se utilizaba: `AUTH <password>`
- En `Redis >= 6`:
    - Se introdujo el sistema ACL (Access Control List).
    - Permite definir usuarios con nombre, contrase√±a y privilegios espec√≠ficos.
    - Se autentica con: `AUTH <username> <password>`

### Comandos principales de ACL

| Comando                              | Descripci√≥n                                           |
|--------------------------------------|-------------------------------------------------------|
| `ACL LIST`                           | Lista todos los usuarios configurados y sus permisos. |
| `ACL WHOAMI`                         | Muestra el usuario actualmente autenticado.           |
| `ACL SETUSER [username] >[password]` | Crea o actualiza un usuario con contrase√±a.           |
| `ACL SETUSER [username] nopass`      | Crea un usuario sin contrase√±a.                       |
| `ACL SETUSER [username] on`          | Habilita al usuario.                                  |
| `ACL SETUSER [username] off`         | Deshabilita al usuario.                               |
| `ACL DELUSER [username]`             | Elimina un usuario.                                   |

### Ejemplos pr√°cticos

- Ver usuarios actuales

````bash
127.0.0.1:6379> acl list
1) "user default on nopass sanitize-payload ~* &* +@all"
````

El resultado indica:

- `default`: usuario activo.
- `nopass`: sin contrase√±a.
- `+@all`: permisos completos.

- Ver usuario actual

````bash
127.0.0.1:6379> acl whoami
"default" 
````

- Crear usuarios

````bash
127.0.0.1:6379> ACL SETUSER sam on >'secret'
OK
127.0.0.1:6379> ACL SETUSER jake >'secret'
OK
127.0.0.1:6379> ACL SETUSER magadiflo >123456
OK 
````

üìå Observaciones:

- `>` indica que lo que sigue es la contrase√±a.
- Por defecto, el usuario reci√©n creado queda deshabilitado a menos que uses on.

- Revisar usuarios

````bash
127.0.0.1:6379> acl list
1) "user default on nopass sanitize-payload ~* &* +@all"
2) "user jake off sanitize-payload #2bb80d537b1da3e38bd30361aa855686bde0eacd7162fef6a25fe97bf527a25b resetchannels -@all"
3) "user magadiflo off sanitize-payload #8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92 resetchannels -@all"
4) "user sam on sanitize-payload #2bb80d537b1da3e38bd30361aa855686bde0eacd7162fef6a25fe97bf527a25b resetchannels -@all" 
````

Notas:

- El `#<hash>` corresponde al hash `SHA-256` de la contrase√±a.
- `resetchannels` y `-@all` aparecen porque los usuarios no tienen permisos definidos expl√≠citamente.

- Eliminar usuarios

````bash
127.0.0.1:6379> acl deluser jake sam
(integer) 2 
````

- Habilitar un usuario existente

````bash
127.0.0.1:6379> acl setuser magadiflo on
OK 
````

- Autenticarse con un usuario distinto

````bash
127.0.0.1:6379> auth magadiflo 123456
OK 
````

- Regresamos al usuario default

````bash
127.0.0.1:6379> auth default nopass
OK 
````

- Confirmar usuario actual

````bash
127.0.0.1:6379> acl whoami
"default" 
````

### Notas importantes

- En producci√≥n, nunca uses el usuario `default` con acceso total y sin contrase√±a.
- Es recomendable:
    - Deshabilitar `default` `(ACL SETUSER default off)`.
    - Crear usuarios espec√≠ficos con permisos limitados seg√∫n el caso de uso.
- Los permisos se definen con `categor√≠as` (`+@read`, `+@write`, `+@admin`, etc.) o comandos individuales
  (`+get`, `-del`, etc.).
- Los usuarios pueden restringirse tambi√©n a claves espec√≠ficas `(~prefix:*)`.

## Access Control List - Configurando permisos

La forma general de crear un usuario en Redis con ACL es:

````bash
ACL SETUSER [username] >[password] ON 
````

Al crear un usuario podemos asignarle permisos de acceso a comandos y claves.

### Principales flags de permisos

- Permisos sobre comandos
    - `allcommands` o `+@all`: acceso a todos los comandos.
    - `+@set`, `+@hash`, `+@list`: acceso a categor√≠as espec√≠ficas de comandos (sets, hashes, listas, etc.).
    - `+[command]`: habilita un comando individual.
    - `-[command]`: deshabilita un comando individual.
    - Ejemplo:
        - `-get` ‚Üí niega el comando GET.
        - `+set` ‚Üí permite el comando SET.
- Permisos sobre claves
    - `allkeys` o `~*`: acceso a todas las claves.
    - `~prefix:*`: acceso restringido a claves que empiecen con `prefix:`.
    - Ejemplo:
        - `~numbers:*` ‚Üí acceso a todas las claves con prefijo `numbers:`.

### Ejemplos pr√°cticos

- Crear un usuario con acceso total

````bash
127.0.0.1:6379> acl setuser magadiflo >pass123 on allcommands allkeys
OK
````

- Ver configuraci√≥n de usuarios

````bash
127.0.0.1:6379> acl list
1) "user default on nopass sanitize-payload ~* &* +@all"
2) "user magadiflo on sanitize-payload #9b8769a4a742959a2d0298c36fb70623f2dfacda8436237df08d8dfd5b37374c ~* resetchannels +@all"
````

üìå El hash (#9b87...) corresponde a la contrase√±a almacenada en formato SHA-256.

- Autenticarse como nuevo usuario

````bash
127.0.0.1:6379> auth magadiflo pass123
OK 

127.0.0.1:6379> acl whoami
"magadiflo" 
````

- Usar comandos con permisos completos

````bash
127.0.0.1:6379> set product laptop
OK
127.0.0.1:6379> get product
"laptop" 
````

- Volver al usuario `default`

````bash
127.0.0.1:6379> auth default nopass   
OK                                     
````

- Quitamos permiso al comando GET para el usuario `magadiflo`

````bash
127.0.0.1:6379> acl setuser magadiflo -get
OK 
````

- Verificamos cambios

````bash
127.0.0.1:6379> acl list
1) "user default on nopass sanitize-payload ~* &* +@all"
2) "user magadiflo on sanitize-payload #9b8769a4a742959a2d0298c36fb70623f2dfacda8436237df08d8dfd5b37374c ~* resetchannels +@all -get" 
````

- Intentar usar un comando restringido

````bash
127.0.0.1:6379> auth magadiflo pass123
OK 

127.0.0.1:6379> get product
(error) NOPERM User magadiflo has no permissions to run the 'get' command
````

## Redisson ‚Äì Configurando credenciales con ACL

En la lecci√≥n anterior creamos el usuario `magadiflo` con contrase√±a `pass123` y le quitamos el permiso de ejecutar el
comando `GET (-get)`.

Hasta este punto, en los ejemplos anteriores nos conect√°bamos a `Redis` sin credenciales (usuario `default`, sin
contrase√±a). Ahora configuraremos `Redisson` para usar un usuario espec√≠fico con `ACL`.

### Configuraci√≥n en Redisson

En el proyecto `projects/redisson-playground`, dentro de la clase de configuraci√≥n, agregamos las credenciales:

````java
public class RedissonConfig {

    private RedissonClient redissonClient;

    public RedissonClient getClient() {
        if (Objects.isNull(this.redissonClient)) {
            Config config = new Config();
            config.useSingleServer()
                    .setAddress("redis://127.0.0.1:6379")   // conexi√≥n al servidor Redis
                    .setPassword("pass123")                 // usuario ACL
                    .setUsername("magadiflo");              // contrase√±a del usuario
            this.redissonClient = Redisson.create(config);
        }
        return this.redissonClient;
    }

    public RedissonReactiveClient getReactiveClient() {
        return this.getClient().reactive();
    }
}
````

üìå Notas:

- `setUsername(...)` y `setPassword(...)` permiten autenticarse con un usuario ACL creado en Redis 6+.
- Si omites estas l√≠neas, la conexi√≥n se har√° con el usuario `default` sin contrase√±a.
- `redis://127.0.0.1:6379` ‚Üí protocolo redis, host y puerto del servidor.

### Test con GET restringido

Probemos un Key-Value test que usa SET y GET:

````java

@Slf4j
class Lec01KeyValueTest extends BaseTest {

    @Test
    void keyValueAccessTest() {
        RBucketReactive<String> bucket = this.client.getBucket("user:1:name");
        Mono<Void> set = bucket.set("sam");
        Mono<Void> get = bucket.get()
                .doOnNext(s -> log.info("{}", s))
                .then();

        StepVerifier.create(set.concatWith(get))
                .verifyComplete();
    }
}
````

üìå Resultado esperado:

- El `SET` se ejecuta sin problema (no est√° restringido).
- El `GET` falla, ya que nuestro usuario `magadiflo` no tiene permisos para ejecutarlo.

````bash
java.lang.AssertionError: expectation "expectComplete" failed (expected: onComplete(); actual: onError(org.redisson.client.RedisException: NOPERM User magadiflo has no permissions to run the 'get' command. channel: [id: 0x2823236f, L:/127.0.0.1:55602 - R:127.0.0.1/127.0.0.1:6379] command: (GET), params: [user:1:name], promise: java.util.concurrent.CompletableFuture@24b2021a[Not completed, 1 dependents])) 
````

Esto confirma que las `ACL` en `Redis` afectan directamente al cliente `Redisson`.

### Test con comandos permitidos

Ahora probemos con una estructura distinta: `HyperLogLog`. Este tipo de estructura no utiliza `GET`, por lo que deber√≠a
ejecutarse sin problemas:

````java

@Slf4j
class Lec11HyperLogLogTest extends BaseTest {
    @Test
    void count() {
        RHyperLogLogReactive<Long> counter = this.client.getHyperLogLog("user:visits", LongCodec.INSTANCE);

        // Suponiendo que tenemos muchos datos
        List<Long> list1 = LongStream.rangeClosed(1, 25_000).boxed().toList();
        List<Long> list2 = LongStream.rangeClosed(25_001, 50_000).boxed().toList();
        List<Long> list3 = LongStream.rangeClosed(50_000, 75_000).boxed().toList();
        List<Long> list4 = LongStream.rangeClosed(75_001, 100_000).boxed().toList();

        Mono<Void> mono = Flux.just(list1, list2, list3, list4)
                .flatMap(counter::addAll)
                .then();

        StepVerifier.create(mono)
                .verifyComplete();

        counter.count()
                .doOnNext(i -> log.info("{}", i))
                .subscribe();
    }
}
````

Vemos que se ejecuta sin problemas dado que aqu√≠ no se usa el comando get.

````bash
12:24:05.583 [redisson-netty-1-12] DEBUG org.redisson.command.RedisExecutor -- connection released for command: (PFCOUNT), params: [user:visits] from slot NodeSource [slot=0, addr=null, redisClient=null, redirect=null, entry=null] using connection RedisConnection@2032122685 [redisClient=[addr=redis://127.0.0.1:6379,127.0.0.1/127.0.0.1:6379], channel=[id: 0xb779039c, L:/127.0.0.1:55713 - R:127.0.0.1/127.0.0.1:6379], currentCommand=CommandData [command=(PFCOUNT), params: [user:visits], promise: java.util.concurrent.CompletableFuture@1d1cd1be[Completed normally], codec=org.redisson.client.codec.LongCodec], usage=0]
12:24:05.584 [redisson-netty-1-12] INFO dev.magadiflo.test.Lec11HyperLogLogTest -- 99562 
````

‚úÖ El test funciona correctamente porque los comandos `PFADD` y `PFCOUNT` no est√°n restringidos en la ACL del usuario.

## Redis Default User Credentials

`Redis` por defecto viene con un usuario llamado `default`, el cual:

- Est√° habilitado autom√°ticamente.
- Tiene acceso a todos los comandos `(+@all)`.
- Puede acceder a todas las claves `(~*)`.
- Inicialmente no requiere contrase√±a `(nopass)`.

Esto representa un riesgo de seguridad en entornos productivos, ya que cualquiera que se conecte al servidor puede
ejecutar cualquier comando.

### Asignando contrase√±a al usuario default

Podemos proteger el usuario `default` de dos formas:

1. M√©todo moderno (recomendado, Redis >= 6)

````bash
127.0.0.1:6379> ACL SETUSER default >pass123 on 
````

üìå Esto configura al usuario `default` con contrase√±a `pass123` y lo mantiene habilitado.

2. M√©todo cl√°sico (requirepass)

`Redis` tambi√©n soporta el par√°metro `requirepass`, usado en versiones `< 6` y todav√≠a v√°lido en `>= 6`.

````bash
127.0.0.1:6379> acl whoami
"default"
127.0.0.1:6379> config set requirepass pass123
OK 
````

Con esto, cualquier cliente deber√° autenticarse antes de ejecutar comandos.

### Probando el cambio

Si reiniciamos el cliente `redis-cli`.

````bash
/data # redis-cli
127.0.0.1:6379> acl whoami
(error) NOAUTH Authentication required.
````

Nos autenticamos con `default`.

````bash
127.0.0.1:6379> auth default pass123
OK 
````

Ahora podemos ejecutar comandos normalmente.

### Volver al estado sin contrase√±a

Si queremos deshabilitar la autenticaci√≥n del `default`, basta con:

````bash
127.0.0.1:6379> config set requirepass "" 
OK                                         
````
